(function(tinymce) {
  tinymce.PluginManager.add('mceStageindent', function(editor, url, $) {
    editor.on('init', function() {
      editor.formatter.register({
        mceStageindent: { selector: 'p', styles: { 'text-indent': '%value' }}
      })
    })

    editor.addButton('mceStageindent', function() {
      const items = [
        {
          text: '1字符',
          value: '1em'
        },
        {
          text: '2字符',
          value: '2em'
        },
        {
          text: '4字符',
          value: '4em'
        },
        {
          text: '取消缩进',
          value: '0'
        }
      ]
      return {
        type: 'listbox',
        text: '缩进',
        tooltip: '首行缩进',
        values: items,
        fixedWidth: true,
        onPostRender: function() {
          var self = this
          editor.on('nodeChange', function(e) {
            var formatName = 'mceStageindent'
            var formatter = editor.formatter
            var value = null
            e.parents.forEach(function(node) {
              items.forEach(function(item) {
                if (formatName) {
                  if (formatter.matchNode(node, formatName, { value: item.value })) {
                    value = item.value
                  }
                } else {
                  if (formatter.matchNode(node, item.value)) {
                    value = item.value
                  }
                }
                if (value) {
                  return false
                }
              })
              if (value) {
                return false
              }
            })
            self.value(value)
          })
        },
        onselect: function(e) {
          tinymce.activeEditor.formatter.apply('mceStageindent', { value: this.value() })
        }
      }
    })
  })

  tinymce.PluginManager.requireLangPack('mceStageindent', 'de')
})(window.tinymce)

